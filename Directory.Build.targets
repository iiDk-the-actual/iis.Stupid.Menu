<?xml version="1.0" encoding="utf-8" ?>
<Project>
  <PropertyGroup>
    <GamePath>D:\SteamLibrary\steamapps\common\Gorilla Tag</GamePath>
    <GameAssemblyPath>$(GamePath)\Gorilla Tag_Data\Managed</GameAssemblyPath>
    <BepInExAssemblyPath>$(GamePath)\BepInEx\core</BepInExAssemblyPath>
    <PluginsPath>$(GamePath)\BepInEx\plugins</PluginsPath>

    <BuildTimestamp>$([System.DateTime]::UtcNow.ToString("yyyy-MM-ddTHH:mm:ssZ"))</BuildTimestamp>
  </PropertyGroup>

  <Target Name="UpdateBuildTimestamp" BeforeTargets="BeforeBuild">
    <PropertyGroup>
      <OriginalFileContent>$([System.IO.File]::ReadAllText('$(MSBuildProjectDirectory)\PluginInfo.cs'))</OriginalFileContent>
      <Pattern>public const string BuildTimestamp = ".*?";</Pattern>
      <Replacement>public const string BuildTimestamp = "$(BuildTimestamp)";</Replacement>
      <UpdatedFileContent>$([System.Text.RegularExpressions.Regex]::Replace($(OriginalFileContent), $(Pattern), $(Replacement)))</UpdatedFileContent>
    </PropertyGroup>

    <WriteLinesToFile
        File="PluginInfo.cs"
        Lines="$(UpdatedFileContent)"
        Overwrite="true"
        Encoding="UTF-8"
        WriteOnlyWhenDifferent="true"/>
  </Target>

  <Target Name="CopyToPlugins" AfterTargets="Build">
    <Copy SourceFiles="$(TargetPath)" DestinationFiles="$(PluginsPath)\$(TargetFileName)" />
    <Message Text="Copied to Plugins" Importance="high"/>
  </Target>
</Project>